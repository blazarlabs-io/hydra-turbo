# BLE Protocol

The Blazar Terminal uses Bluetooth Low Energy (BLE) to communicate with mobile devices. This section details the BLE service structure, characteristics, and communication protocol.

## BLE Service Definition

### Service UUID

**Primary Service UUID**: `1d4ddcb2-279d-42e2-a95a-274352a25248`

This UUID identifies the Blazar Terminal service and is used for device discovery and connection.

### Device Advertising

**Device Name**: "Blazar TERM"

**Advertising Parameters**:
- **Service UUIDs**: `1d4ddcb2-279d-42e2-a95a-274352a25248`
- **Connectable**: Yes
- **Discoverable**: Yes
- **Advertising Interval**: 100ms (configurable)

## BLE Characteristics

The Blazar Terminal exposes four BLE characteristics for payment data exchange:

### 1. Merchant Address (Read-Only)

**UUID**: `a781af9a-9a04-4422-9d78-9014497ccdc0`  
**Properties**: Read  
**Data Format**: UTF-8 string  
**Purpose**: Contains the merchant's Cardano address

**Example**:
```
addr1q9x... (merchant's Cardano address)
```

### 2. Payment Amount (Read-Only)

**UUID**: `61b64163-35fa-438a-810c-018d1a719667`  
**Properties**: Read  
**Data Format**: UTF-8 integer string  
**Purpose**: Payment amount in smallest unit (e.g., lovelace)

**Example**:
```
10000000 (10 ADA in lovelace)
```

### 3. Asset Unit (Read-Only)

**UUID**: `52f34145-0363-4f4e-9fab-a133e8e5b0b1`  
**Properties**: Read  
**Data Format**: UTF-8 string  
**Purpose**: Asset identifier for the payment

**Examples**:
```
lovelace (for ADA payments)
policyId.assetName (for custom assets)
```

### 4. Client Address (Read/Write)

**UUID**: `9b16159d-7c3e-4ae6-990b-0d34f22389bb`  
**Properties**: Read, Write  
**Data Format**: UTF-8 string  
**Purpose**: Client's Cardano address for payment authorization

**Example**:
```
addr1q9x... (client's Cardano address)
```

## BLE Communication Flow

### 1. Device Discovery

Mobile applications discover Blazar Terminals by scanning for the service UUID:

```javascript
// Mobile app discovers terminal
const serviceUUIDs = ['1d4ddcb2-279d-42e2-a95a-274352a25248'];
const deviceName = 'Blazar TERM';

// Scan for devices
bleManager.startDeviceScan(serviceUUIDs, null, (error, device) => {
  if (device && device.name === 'Blazar TERM') {
    console.log('Found Blazar Terminal:', device.id);
    // Connect to device
    connectToTerminal(device);
  }
});
```

### 2. Connection Establishment

Once a terminal is discovered, the mobile app establishes a BLE connection:

```javascript
// Connect to terminal
await device.connect();
await device.discoverAllServicesAndCharacteristics();

// Get the Blazar service
const service = await device.getService('1d4ddcb2-279d-42e2-a95a-274352a25248');
```

### 3. Reading Payment Details

The mobile app reads the payment characteristics to get payment information:

```javascript
// Read merchant address
const merchantChar = await service.getCharacteristic('a781af9a-9a04-4422-9d78-9014497ccdc0');
const merchantAddress = await merchantChar.read();
console.log('Merchant Address:', merchantAddress.toString('utf8'));

// Read payment amount
const amountChar = await service.getCharacteristic('61b64163-35fa-438a-810c-018d1a719667');
const amountBuffer = await amountChar.read();
const amount = parseInt(amountBuffer.toString('utf8'));
console.log('Payment Amount:', amount);

// Read asset unit
const assetChar = await service.getCharacteristic('52f34145-0363-4f4e-9fab-a133e8e5b0b1');
const assetBuffer = await assetChar.read();
const assetUnit = assetBuffer.toString('utf8');
console.log('Asset Unit:', assetUnit);
```

### 4. Payment Authorization

The mobile app writes the client address to authorize the payment:

```javascript
// Write client address to trigger payment
const clientChar = await service.getCharacteristic('9b16159d-7c3e-4ae6-990b-0d34f22389bb');
const clientAddress = 'addr1q9x...'; // Client's Cardano address
const addressBuffer = Buffer.from(clientAddress, 'utf8');
await clientChar.writeWithResponse(addressBuffer);
```

## Complete Mobile Integration Example

### React Native Implementation

```javascript
import { BleManager } from 'react-native-ble-plx';

class BlazarTerminalClient {
  constructor() {
    this.bleManager = new BleManager();
    this.device = null;
    this.service = null;
  }

  async scanForTerminal() {
    const serviceUUIDs = ['1d4ddcb2-279d-42e2-a95a-274352a25248'];
    
    return new Promise((resolve, reject) => {
      this.bleManager.startDeviceScan(serviceUUIDs, null, (error, device) => {
        if (error) {
          reject(error);
          return;
        }
        
        if (device && device.name === 'Blazar TERM') {
          this.bleManager.stopDeviceScan();
          this.device = device;
          resolve(device);
        }
      });
    });
  }

  async connectToTerminal() {
    if (!this.device) {
      throw new Error('No device found. Call scanForTerminal() first.');
    }

    await this.device.connect();
    await this.device.discoverAllServicesAndCharacteristics();
    
    this.service = await this.device.getService('1d4ddcb2-279d-42e2-a95a-274352a25248');
    console.log('Connected to Blazar Terminal');
  }

  async getPaymentDetails() {
    const service = this.service;
    const characteristics = await service.characteristics();

    // Read merchant address
    const merchantChar = characteristics.find(c => 
      c.uuid === 'a781af9a-9a04-4422-9d78-9014497ccdc0'
    );
    const merchantAddress = (await merchantChar.read()).toString('utf8');

    // Read payment amount
    const amountChar = characteristics.find(c => 
      c.uuid === '61b64163-35fa-438a-810c-018d1a719667'
    );
    const amount = parseInt((await amountChar.read()).toString('utf8'));

    // Read asset unit
    const assetChar = characteristics.find(c => 
      c.uuid === '52f34145-0363-4f4e-9fab-a133e8e5b0b1'
    );
    const assetUnit = (await assetChar.read()).toString('utf8');

    return {
      merchantAddress,
      amount,
      assetUnit
    };
  }

  async initiatePayment(clientAddress) {
    const service = this.service;
    const characteristics = await service.characteristics();

    // Write client address to trigger payment
    const clientChar = characteristics.find(c => 
      c.uuid === '9b16159d-7c3e-4ae6-990b-0d34f22389bb'
    );
    
    const addressBuffer = Buffer.from(clientAddress, 'utf8');
    await clientChar.writeWithResponse(addressBuffer);
    
    console.log('Payment initiated for address:', clientAddress);
  }

  async disconnect() {
    if (this.device) {
      await this.device.cancelConnection();
      this.device = null;
      this.service = null;
    }
  }
}

// Usage example
async function processPayment(clientAddress) {
  const terminal = new BlazarTerminalClient();
  
  try {
    // Scan for terminal
    await terminal.scanForTerminal();
    
    // Connect
    await terminal.connectToTerminal();
    
    // Get payment details
    const paymentDetails = await terminal.getPaymentDetails();
    console.log('Payment Details:', paymentDetails);
    
    // Confirm payment with user
    const confirmed = await confirmPayment(paymentDetails);
    if (confirmed) {
      // Initiate payment
      await terminal.initiatePayment(clientAddress);
      console.log('Payment processing initiated');
    }
    
  } catch (error) {
    console.error('Payment failed:', error);
  } finally {
    await terminal.disconnect();
  }
}
```

## Terminal Implementation

### BLE Service Setup

```javascript
const bleno = require('bleno');

class BlazarTerminalBLE {
  constructor() {
    this.service = null;
    this.isAdvertising = false;
  }

  setupService(paymentData) {
    const { address, amount, decimals, assetUnit } = paymentData;
    
    // Calculate amount in smallest unit
    const multiplier = Math.pow(10, decimals);
    const amountInSmallestUnit = Math.floor(amount * multiplier);
    
    // Create characteristics
    const merchantAddressChar = new bleno.Characteristic({
      uuid: 'a781af9a-9a04-4422-9d78-9014497ccdc0',
      properties: ['read'],
      value: Buffer.from(address, 'utf8'),
      onReadRequest: (offset, callback) => {
        callback(bleno.Characteristic.RESULT_SUCCESS, Buffer.from(address, 'utf8'));
      }
    });

    const paymentAmountChar = new bleno.Characteristic({
      uuid: '61b64163-35fa-438a-810c-018d1a719667',
      properties: ['read'],
      value: Buffer.from(amountInSmallestUnit.toString(), 'utf8'),
      onReadRequest: (offset, callback) => {
        callback(bleno.Characteristic.RESULT_SUCCESS, 
          Buffer.from(amountInSmallestUnit.toString(), 'utf8'));
      }
    });

    const assetUnitChar = new bleno.Characteristic({
      uuid: '52f34145-0363-4f4e-9fab-a133e8e5b0b1',
      properties: ['read'],
      value: Buffer.from(assetUnit, 'utf8'),
      onReadRequest: (offset, callback) => {
        callback(bleno.Characteristic.RESULT_SUCCESS, Buffer.from(assetUnit, 'utf8'));
      }
    });

    const clientAddressChar = new bleno.Characteristic({
      uuid: '9b16159d-7c3e-4ae6-990b-0d34f22389bb',
      properties: ['read', 'write'],
      onReadRequest: (offset, callback) => {
        callback(bleno.Characteristic.RESULT_SUCCESS, Buffer.from('', 'utf8'));
      },
      onWriteRequest: (data, offset, withoutResponse, callback) => {
        try {
          const clientAddress = data.toString('utf8');
          console.log('Received client address:', clientAddress);
          
          // Process payment (this would trigger the payment flow)
          this.processPayment(clientAddress, paymentData);
          
          callback(bleno.Characteristic.RESULT_SUCCESS);
        } catch (error) {
          console.error('Error processing client address:', error);
          callback(bleno.Characteristic.RESULT_UNLIKELY_ERROR);
        }
      }
    });

    // Create service
    this.service = new bleno.PrimaryService({
      uuid: '1d4ddcb2-279d-42e2-a95a-274352a25248',
      characteristics: [
        merchantAddressChar,
        paymentAmountChar,
        assetUnitChar,
        clientAddressChar
      ]
    });
  }

  startAdvertising(paymentData) {
    if (this.isAdvertising) {
      this.stopAdvertising();
    }

    this.setupService(paymentData);

    bleno.on('stateChange', (state) => {
      console.log('BLE State:', state);
      if (state === 'poweredOn') {
        bleno.startAdvertising('Blazar TERM', ['1d4ddcb2-279d-42e2-a95a-274352a25248']);
      }
    });

    bleno.on('advertisingStart', (error) => {
      if (!error) {
        console.log('BLE Advertising started');
        bleno.setServices([this.service]);
        this.isAdvertising = true;
      } else {
        console.error('BLE Advertising failed:', error);
      }
    });
  }

  stopAdvertising() {
    if (this.isAdvertising) {
      bleno.stopAdvertising();
      bleno.disconnect();
      this.isAdvertising = false;
      console.log('BLE Advertising stopped');
    }
  }

  processPayment(clientAddress, paymentData) {
    // This would trigger the payment processing flow
    console.log('Processing payment:', {
      clientAddress,
      merchantAddress: paymentData.address,
      amount: paymentData.amount,
      assetUnit: paymentData.assetUnit
    });
    
    // Trigger payment processing via API calls
    // (Implementation would call the Blazar API)
  }
}

module.exports = BlazarTerminalBLE;
```

## Error Handling

### Common BLE Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `Device not found` | Terminal not advertising | Check terminal is running and Bluetooth enabled |
| `Connection failed` | Out of range or interference | Move closer to terminal, check for interference |
| `Characteristic not found` | Wrong UUID or service | Verify UUIDs match exactly |
| `Write failed` | Invalid data format | Ensure data is UTF-8 encoded string |
| `Permission denied` | BLE permissions not granted | Grant location and Bluetooth permissions |

### Debugging

```javascript
// Enable BLE debugging
const bleManager = new BleManager({
  restoreStateIdentifier: 'BleManagerRestoreStateIdentifier',
  restoreStateFunction: (restoredState) => {
    console.log('BLE State restored:', restoredState);
  }
});

// Monitor state changes
bleManager.onStateChange((state) => {
  console.log('BLE Manager State:', state);
  if (state === 'PoweredOn') {
    // Ready to scan
  }
});
```

## Security Considerations

### Data Protection
- BLE communication is not encrypted by default
- Sensitive data (addresses) are transmitted in plain text
- Consider implementing additional encryption for production use

### Best Practices
- Validate all received data before processing
- Implement timeout mechanisms for payment requests
- Use secure random UUIDs for service identification
- Regularly rotate service UUIDs if needed

## Next Steps

- **[API Integration](/blazar-terminal/api-integration)** - Backend API integration
- **[Payment Flow](/blazar-terminal/payment-flow)** - Complete payment processing flow
- **[Usage Guide](/blazar-terminal/usage-guide)** - Usage instructions
- **[Troubleshooting](/blazar-terminal/troubleshooting)** - Common issues and solutions
