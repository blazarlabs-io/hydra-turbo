# API Integration

The Blazar Terminal integrates with the Blazar API backend for payment processing, fund verification, and transaction management.

## API Overview

### Base Configuration

**Backend Base URL**:
```javascript
const API_BASE_URL = "http://192.168.18.4:5000"; // example, replace per env
```

**Environment Configuration**:
```javascript
// Production API endpoint
const API_BASE_URL = process.env.API_BASE_URL || "https://api.blazarpay.com";

// Development API endpoint
const API_BASE_URL = process.env.API_BASE_URL || "http://localhost:5000";
```

## API Endpoints

### 1. Query Funds

**Endpoint**: `GET /query-funds?address={clientAddress}`

**Purpose**: Retrieves available funds and UTXO references for a client address.

**Parameters**:
- `address` (string, required): Client's Cardano address

**Response Format**:
```json
{
  "success": true,
  "fundsInL2": [
    {
      "txHash": "transaction_hash_string",
      "outputIndex": 0,
      "amount": 10000000,
      "assetUnit": "lovelace"
    }
  ],
  "totalBalance": 10000000
}
```

**Implementation**:
```javascript
async function queryFunds(address) {
  return new Promise((resolve, reject) => {
    fetch(`${API_BASE_URL}/query-funds?address=${address}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        resolve(data);
      })
      .catch(error => {
        reject(error);
      });
  });
}
```

### 2. Pay Merchant

**Endpoint**: `POST /pay-merchant`

**Purpose**: Processes payment from client to merchant.

**Request Body**:
```json
{
  "merchant_address": "string",
  "funds_utxo_ref": {
    "hash": "string",
    "index": "number"
  },
  "amount": [
    ["asset_unit", 123],
    ["lovelace", 3000000]
  ],
  "signature": "string"
}
```

**Response Format**:
```json
{
  "success": true,
  "transactionId": "transaction_id_string",
  "status": "confirmed",
  "amount": 10000000,
  "fee": 3000000
}
```

**Implementation**:
```javascript
async function payMerchant(
  clientAddress,
  merchantAddress,
  amountToPay,
  txHash,
  outputIndex,
  assetUnit
) {
  return new Promise((resolve, reject) => {
    const payload = {
      merchant_address: merchantAddress,
      funds_utxo_ref: {
        hash: txHash,
        index: outputIndex
      },
      amount: [
        [assetUnit, parseInt(amountToPay)],
        ["lovelace", 3000000] // Fee in lovelace
      ],
      signature: ""
    };

    fetch(`${API_BASE_URL}/pay-merchant`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      resolve(data);
    })
    .catch(error => {
      reject(error);
    });
  });
}
```

## WebSocket Server

### Server Configuration

**Port**: 3000  
**Protocol**: Socket.IO  
**CORS**: Configurable origin

**Implementation**:
```javascript
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');

const app = express();
const server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: 'http://localhost:3000', // Configurable
    methods: ['GET', 'POST'],
  },
});

server.listen(3000, () => {
  console.log('WebSocket server listening on port 3000');
});
```

### WebSocket Events

#### Incoming Events (Merchant → Terminal)

##### `requestFunds`

Initiates a payment request on the terminal.

**Payload**:
```javascript
{
  address: "merchant_cardano_address",
  amount: 25.0,
  decimals: 6,
  assetUnit: "lovelace"
}
```

**Example**:
```javascript
const socket = io('http://terminal-ip:3000');

socket.emit('requestFunds', {
  address: 'addr1q9x...',
  amount: 25.0,
  decimals: 6,
  assetUnit: 'lovelace'
});
```

##### `disconnect`

Handles merchant disconnection gracefully.

### Outgoing Events (Terminal → Merchant)

#### `payed`

Notifies merchant of successful payment completion.

**Payload**:
```javascript
{
  clientAddress: "client_cardano_address",
  merchantAddress: "merchant_cardano_address",
  amount: 25000000,
  transactionId: "transaction_id_string"
}
```

## Complete Integration Example

### Merchant Application Integration

```javascript
const io = require('socket.io-client');

class BlazarTerminalClient {
  constructor(terminalUrl) {
    this.socket = io(terminalUrl);
    this.setupEventHandlers();
  }

  setupEventHandlers() {
    this.socket.on('connect', () => {
      console.log('Connected to Blazar Terminal');
    });

    this.socket.on('payed', (paymentData) => {
      console.log('Payment received:', paymentData);
      this.handlePaymentReceived(paymentData);
    });

    this.socket.on('disconnect', () => {
      console.log('Disconnected from terminal');
    });
  }

  requestPayment(merchantAddress, amount, decimals = 6, assetUnit = 'lovelace') {
    const paymentRequest = {
      address: merchantAddress,
      amount: amount,
      decimals: decimals,
      assetUnit: assetUnit
    };

    this.socket.emit('requestFunds', paymentRequest);
    console.log('Payment request sent:', paymentRequest);
  }

  handlePaymentReceived(paymentData) {
    // Process payment confirmation
    console.log('Payment confirmed:', {
      client: paymentData.clientAddress,
      amount: paymentData.amount,
      merchant: paymentData.merchantAddress
    });
  }

  disconnect() {
    this.socket.disconnect();
  }
}

// Usage
const terminal = new BlazarTerminalClient('http://192.168.1.100:3000');
terminal.requestPayment('addr1q9x...', 15.5);
```

### Terminal WebSocket Handler

```javascript
io.on('connection', (socket) => {
  console.log('Merchant connected');

  socket.on('requestFunds', (data) => {
    console.log('Payment requested:', data);
    
    // Setup BLE characteristics with payment data
    const { Char1, Char2, Char3, Char4 } = setupCharacteristics(data);
    
    // Start BLE advertising
    bleno.on('stateChange', (state) => {
      if (state === 'poweredOn') {
        bleno.startAdvertising('Blazar TERM', [SERVICE_UUID]);
      }
    });
  });

  socket.on('disconnect', () => {
    console.log('Merchant disconnected');
    // Stop BLE advertising
    bleno.stopAdvertising();
  });
});
```

## Error Handling

### API Error Handling

```javascript
async function handleApiError(error) {
  if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
    console.error('Network error: Unable to connect to API server');
  } else if (error.response) {
    console.error('API Error:', error.response.status, error.response.data);
  } else {
    console.error('Unexpected error:', error.message);
  }
}

// Usage in API calls
try {
  const funds = await queryFunds(clientAddress);
  // Process funds
} catch (error) {
  handleApiError(error);
}
```

### WebSocket Error Handling

```javascript
socket.on('connect_error', (error) => {
  console.error('Connection failed:', error);
});

socket.on('error', (error) => {
  console.error('Socket error:', error);
});
```

## Security Considerations

### API Security

- **HTTPS**: Use HTTPS for all API communications in production
- **Authentication**: Implement API key authentication for terminal identification
- **Rate Limiting**: Implement rate limiting for payment requests
- **Input Validation**: Validate all API inputs on both client and server

### WebSocket Security

- **CORS Configuration**: Restrict CORS to known merchant application origins
- **Authentication**: Implement optional authentication for WebSocket connections
- **Message Validation**: Validate all incoming WebSocket messages
- **Connection Limits**: Implement connection limits per merchant

## Testing

### API Testing

```javascript
// Test API connectivity
async function testApiConnection() {
  try {
    const response = await fetch(`${API_BASE_URL}/health`);
    if (response.ok) {
      console.log('API connection successful');
    } else {
      console.error('API health check failed');
    }
  } catch (error) {
    console.error('API connection failed:', error);
  }
}
```

### WebSocket Testing

```javascript
// Test WebSocket connection
function testWebSocketConnection(terminalUrl) {
  const socket = io(terminalUrl);
  
  socket.on('connect', () => {
    console.log('WebSocket connection successful');
    socket.disconnect();
  });
  
  socket.on('connect_error', (error) => {
    console.error('WebSocket connection failed:', error);
  });
}
```

## Performance Optimization

### Connection Pooling

```javascript
// Implement connection pooling for API calls
class ApiConnectionPool {
  constructor(maxConnections = 10) {
    this.maxConnections = maxConnections;
    this.activeConnections = 0;
    this.queue = [];
  }

  async executeRequest(requestFn) {
    if (this.activeConnections >= this.maxConnections) {
      return new Promise((resolve, reject) => {
        this.queue.push({ requestFn, resolve, reject });
      });
    }

    this.activeConnections++;
    try {
      const result = await requestFn();
      this.activeConnections--;
      this.processQueue();
      return result;
    } catch (error) {
      this.activeConnections--;
      this.processQueue();
      throw error;
    }
  }

  processQueue() {
    if (this.queue.length > 0 && this.activeConnections < this.maxConnections) {
      const { requestFn, resolve, reject } = this.queue.shift();
      this.executeRequest(requestFn).then(resolve).catch(reject);
    }
  }
}
```

### Caching

```javascript
// Implement response caching
class ApiCache {
  constructor(ttl = 300000) { // 5 minutes default TTL
    this.cache = new Map();
    this.ttl = ttl;
  }

  set(key, value) {
    this.cache.set(key, {
      value,
      timestamp: Date.now()
    });
  }

  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.value;
  }
}
```

## Next Steps

- **[Payment Flow](/blazar-terminal/payment-flow)** - Complete payment processing flow
- **[Usage Guide](/blazar-terminal/usage-guide)** - Usage instructions
- **[Troubleshooting](/blazar-terminal/troubleshooting)** - Common issues and solutions
- **[Development](/blazar-terminal/development)** - Development guidelines
