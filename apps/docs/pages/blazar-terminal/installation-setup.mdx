# Installation & Setup

Complete installation and setup guide for the Blazar Terminal software on Raspberry Pi Zero 2W.

## System Preparation

### 1. Update System Packages

```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Install Node.js

```bash
# Install Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verify installation
node --version
npm --version
```

### 3. Install Bluetooth Dependencies

```bash
sudo apt-get install -y bluetooth bluez libbluetooth-dev build-essential
```

### 4. Configure Bluetooth

```bash
# Enable and start Bluetooth service
sudo systemctl enable bluetooth
sudo systemctl start bluetooth

# Add user to bluetooth group
sudo usermod -a -G bluetooth $USER

# Configure Bluetooth settings
sudo nano /etc/bluetooth/main.conf
```

**Bluetooth Configuration** (`/etc/bluetooth/main.conf`):
```ini
[General]
ControllerMode = dual
DiscoverableTimeout = 0
PairableTimeout = 0
AutoEnable = true
```

**Apply Bluetooth Configuration**:
```bash
sudo systemctl restart bluetooth
```

## Application Setup

### 1. Clone Repository

```bash
cd /opt
sudo git clone <repo-url> blazar-terminal
cd blazar-terminal
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Set Permissions

```bash
sudo chown -R $USER:$USER /opt/blazar-terminal
chmod +x src/index.js
```

### 4. Set Node.js Capabilities

```bash
# Allow Node.js to access Bluetooth without sudo
sudo setcap cap_net_raw+eip $(which node)
```

## Configuration

### 1. API Configuration

Edit the API base URL in `src/services.js`:

```javascript
// Change this to your actual API server
const API_BASE_URL = "http://192.168.18.4:5000";
```

### 2. WebSocket Configuration

Configure WebSocket server settings in `src/socket.js`:

```javascript
const io = new Server(server, {
  cors: {
    origin: "http://localhost:3000", // Configure for your merchant app
    methods: ["GET", "POST"],
  },
});
```

## Service Configuration

### systemd Service Setup

Create systemd service file:

```bash
sudo nano /etc/systemd/system/blazar-terminal.service
```

**Service Configuration** (`/etc/systemd/system/blazar-terminal.service`):
```ini
[Unit]
Description=Blazar Terminal BLE Payment Service
After=bluetooth.service
Wants=bluetooth.service

[Service]
Type=simple
User=pi
WorkingDirectory=/opt/blazar-terminal
ExecStart=/usr/bin/node src/index.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

### Enable and Start Service

```bash
# Reload systemd configuration
sudo systemctl daemon-reload

# Enable service to start on boot
sudo systemctl enable blazar-terminal

# Start the service
sudo systemctl start blazar-terminal

# Check service status
sudo systemctl status blazar-terminal
```

## Testing Installation

### 1. Test Bluetooth

```bash
# Check Bluetooth status
sudo systemctl status bluetooth

# Test BLE scanning
sudo hcitool lescan
```

### 2. Test WebSocket Server

```bash
# Check if port 3000 is listening
netstat -tulpn | grep :3000

# Test WebSocket connection
curl -I http://localhost:3000
```

### 3. Test Application

```bash
# Run in development mode
npm run dev

# Check logs
sudo journalctl -u blazar-terminal.service -f
```

## Development Setup

### 1. Install Development Tools

```bash
# Install nodemon for auto-restart
npm install -g nodemon

# Install development dependencies
npm install --save-dev nodemon
```

### 2. Development Scripts

Add to `package.json`:
```json
{
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  }
}
```

### 3. Run Development Server

```bash
npm run dev
```

## Production Deployment

### 1. Process Management with PM2

```bash
# Install PM2 globally
sudo npm install -g pm2

# Create PM2 ecosystem file
nano ecosystem.config.js
```

**PM2 Configuration** (`ecosystem.config.js`):
```javascript
module.exports = {
  apps: [{
    name: 'blazar-terminal',
    script: 'src/index.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### 2. Start with PM2

```bash
# Start application with PM2
pm2 start ecosystem.config.js

# Save PM2 configuration
pm2 save

# Setup PM2 startup script
pm2 startup
```

## Monitoring and Logs

### 1. Service Logs

```bash
# View service logs
sudo journalctl -u blazar-terminal.service -f

# View recent logs
sudo journalctl -u blazar-terminal.service --since "1 hour ago"
```

### 2. Application Logs

```bash
# View application logs
tail -f /opt/blazar-terminal/logs/app.log

# View error logs
tail -f /opt/blazar-terminal/logs/error.log
```

### 3. System Monitoring

```bash
# Monitor system resources
htop

# Monitor network connections
netstat -tulpn

# Monitor Bluetooth
sudo hcitool lescan
```

## Troubleshooting

### Common Issues

**Bluetooth Not Working**:
```bash
# Restart Bluetooth service
sudo systemctl restart bluetooth

# Check Bluetooth status
sudo systemctl status bluetooth

# Reset Bluetooth adapter
sudo hciconfig hci0 reset
```

**Permission Denied**:
```bash
# Add user to bluetooth group
sudo usermod -a -G bluetooth $USER

# Set Node.js capabilities
sudo setcap cap_net_raw+eip $(which node)

# Logout and login again
```

**WebSocket Connection Failed**:
```bash
# Check if port 3000 is available
netstat -tulpn | grep :3000

# Check firewall settings
sudo ufw status

# Test WebSocket server
curl -I http://localhost:3000
```

**API Connection Failed**:
```bash
# Test API connectivity
curl -I http://192.168.18.4:5000

# Check network configuration
ping 192.168.18.4

# Verify API_BASE_URL in services.js
```

### Debug Commands

```bash
# Check service status
sudo systemctl status blazar-terminal.service

# Check Bluetooth status
sudo systemctl status bluetooth

# Check system resources
free -h
df -h

# Check network connectivity
ping -c 4 8.8.8.8

# Check running processes
ps aux | grep node
```

## Security Considerations

### 1. Firewall Configuration

```bash
# Install UFW firewall
sudo apt install -y ufw

# Configure firewall rules
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 3000

# Enable firewall
sudo ufw enable
```

### 2. SSL/TLS Configuration

For production deployments, consider:

- Using HTTPS for API communications
- Implementing SSL certificates
- Securing WebSocket connections with WSS

### 3. Access Control

- Restrict SSH access to authorized users only
- Use key-based authentication
- Regular security updates

## Maintenance

### 1. Regular Updates

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Update Node.js dependencies
cd /opt/blazar-terminal
npm update
```

### 2. Log Rotation

```bash
# Configure log rotation
sudo nano /etc/logrotate.d/blazar-terminal
```

**Log Rotation Configuration**:
```
/opt/blazar-terminal/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 pi pi
}
```

### 3. Backup Configuration

```bash
# Backup configuration files
sudo tar -czf blazar-terminal-backup.tar.gz /opt/blazar-terminal
```

## Next Steps

- **[BLE Protocol](/blazar-terminal/ble-protocol)** - BLE communication protocol
- **[API Integration](/blazar-terminal/api-integration)** - Backend API integration
- **[Payment Flow](/blazar-terminal/payment-flow)** - Payment processing flow
- **[Usage Guide](/blazar-terminal/usage-guide)** - Usage instructions
